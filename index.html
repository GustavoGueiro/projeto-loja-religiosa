<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loja Religiosa</title>

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#0ea5e9;
      --ring:rgba(14,165,233,.35);
      --success:#16a34a;
      --shadow:0 10px 25px rgba(2,6,23,.06);
      --shadow-hover:0 14px 32px rgba(2,6,23,.12);
      --radius:20px;
    }

    body{
      margin:0;
      height:100vh;
      display:flex;
      background:var(--bg);
      color:var(--text);
      font-family:"Inter",sans-serif;
    }

    /* Sidebar */
    aside{
      width:260px;
      background:var(--card);
      padding:22px 18px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .logo{font-weight:800;font-size:1.15rem}
    .welcome-box{
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      border-radius:12px;
      padding:12px 14px;
      box-shadow:var(--shadow);
    }
    .welcome-box .hello{display:block;color:var(--muted);font-size:.9rem;margin-bottom:4px}
    #welcome-name{color:var(--primary);font-weight:700}

    nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    nav button{
      display:flex;align-items:center;gap:10px;
      width:100%;padding:11px 12px;border-radius:12px;
      background:#f8fafc;border:1px solid #e2e8f0;color:#0f172a;
      cursor:pointer;font-weight:600;transition:.18s;
    }
    nav button:hover{background:var(--primary);color:#fff;border-color:transparent}
    .sidebar-footer{margin-top:auto}
    .btn{padding:10px 14px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(14,165,233,.25)}
    .btn:hover{filter:brightness(.96);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-sair{background:#dc2626;box-shadow:0 6px 14px rgba(220,38,38,.2)}

    main{flex:1;padding:30px 34px;overflow:auto}
    h1{margin:0 0 8px;font-size:1.8rem}
    #boas-vindas{margin:0 0 18px;color:var(--primary);font-weight:600}

    .grid{display:grid;gap:22px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));margin-top:8px}
    .card{
      background:var(--card);border:1px solid rgba(2,6,23,.06);
      border-radius:var(--radius);padding:12px;
      box-shadow:var(--shadow);transition:transform .18s,box-shadow .18s,border-color .18s;
    }
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover);border-color:rgba(2,6,23,.1)}
    .thumb{position:relative;width:100%;aspect-ratio:4/3;overflow:hidden;border-radius:16px;background:#f1f5f9;margin-bottom:12px}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .45s ease}
    .card:hover .thumb img{transform:scale(1.04)}
    .card h3{margin:2px 6px 4px;font-size:1.05rem;font-weight:800}
    .card p{margin:0 6px 12px;color:var(--muted);font-size:.92rem;line-height:1.45;min-height:2.6em}
    .meta{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 6px 6px}
    .price{font-weight:800}

    #sec-dashboard{display:none;margin-top:26px;background:var(--card);border:1px solid #e2e8f0;border-radius:16px;padding:18px;box-shadow:var(--shadow)}
    #sec-dashboard h2{margin:0 0 12px}
  </style>
</head>
<body>
  <aside>
    <div>
      <div class="logo">‚úù Loja Religiosa</div>

      <div class="welcome-box">
        <span class="hello">üôè Bem-vindo(a),</span>
        <strong id="welcome-name">Visitante</strong>
      </div>

      <nav>
        <button id="btnInicio" type="button">üè† In√≠cio</button>
        <button id="btnCatalogo" type="button">üìñ Cat√°logo</button>
        <button id="btnDashboard" type="button" style="display:none;">üìä Dashboard</button>

        <!-- Carrinho -->
        <button id="btnCarrinho" type="button">
          üõí Carrinho
          <span id="cart-count" style="margin-left:8px;background:#0ea5e9;color:#fff;border-radius:10px;padding:1px 8px;font-weight:800">0</span>
        </button>
      </nav>
    </div>

    <div class="sidebar-footer">
      <small style="color:var(--muted);display:block;margin-bottom:8px">
        Logado como <span id="role-label">Cliente</span>
      </small>
      <button id="btnSair" class="btn btn-sair" type="button">Sair</button>
    </div>
  </aside>

  <main>
    <h1>Cat√°logo de Produtos</h1>
    <p id="boas-vindas"></p>

    <!-- Cat√°logo -->
    <div id="produtos" class="grid"></div>

    <!-- Carrinho -->
    <section id="sec-carrinho" style="display:none;margin-top:26px;background:var(--card);border:1px solid #e2e8f0;border-radius:16px;padding:18px;box-shadow:var(--shadow)">
      <h2 style="margin:0 0 12px">Seu Carrinho</h2>

      <div id="cart-empty" style="color:var(--muted);margin-bottom:12px;display:none">
        Seu carrinho est√° vazio. Que tal voltar ao cat√°logo e escolher algo? üôÇ
      </div>

      <div style="overflow:auto">
        <table id="cart-table" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="text-align:left;color:var(--muted);font-size:.9rem">
              <th style="padding:8px 6px;border-bottom:1px solid #e2e8f0">Produto</th>
              <th style="padding:8px 6px;border-bottom:1px solid #e2e8f0">Pre√ßo</th>
              <th style="padding:8px 6px;border-bottom:1px solid #e2e8f0">Qtd</th>
              <th style="padding:8px 6px;border-bottom:1px solid #e2e8f0">Subtotal</th>
              <th style="padding:8px 6px;border-bottom:1px solid #e2e8f0"></th>
            </tr>
          </thead>
          <tbody id="cart-body"></tbody>
        </table>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:14px;gap:12px">
        <button id="btnContinuar" class="btn" type="button" style="background:#475569">‚Üê Continuar comprando</button>
        <div style="display:flex;align-items:center;gap:12px">
          <strong>Total: <span id="cart-total">R$ 0,00</span></strong>
          <button id="btnCheckout" class="btn" type="button">Finalizar compra</button>
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="sec-dashboard">
      <h2>Dashboard de Vendas</h2>
      <canvas id="chartVendas" width="900" height="360"></canvas>
    </section>
  </main>

<script>
  // Detecta o prefixo do reposit√≥rio quando estiver no GitHub Pages (/projeto-loja-religiosa)
  const pathParts = location.pathname.split("/").filter(Boolean);
  const repo = pathParts.length > 0 ? `/${pathParts[0]}` : "";

  // üîó Base da API: localhost em dev, Render em produ√ß√£o
  const API_BASE =
    location.hostname === "localhost" || location.hostname === "127.0.0.1"
      ? "http://localhost:8080"
      : "https://api-loja-religiosa.onrender.com";

  // ---------- CARRINHO ----------
  const CART_KEY = "carrinho";

  function readCart() {
    try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
    catch { return []; }
  }
  function saveCart(cart) {
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    updateCartCount();
  }
  function cartCount() {
    return readCart().reduce((acc, it) => acc + it.qtd, 0);
  }
  function updateCartCount() {
    const el = document.getElementById("cart-count");
    if (el) el.textContent = String(cartCount());
  }
  function addToCart(prod, qtd = 1) {
    const cart = readCart();
    const idx = cart.findIndex(i => String(i.id) === String(prod.id));
    if (idx >= 0) cart[idx].qtd += qtd;
    else cart.push({ id: String(prod.id), nome: prod.nome, preco: Number(prod.preco), imagem: prod.imagem || "", qtd });
    saveCart(cart);
    renderCartTable();
  }
  function setQty(id, qtd) {
    const cart = readCart().map(i => String(i.id) === String(id) ? { ...i, qtd: Math.max(1, qtd) } : i);
    saveCart(cart);
    renderCartTable();
  }
  function incQty(id, delta) {
    const cart = readCart().map(i => String(i.id) === String(id) ? { ...i, qtd: Math.max(1, i.qtd + delta) } : i);
    saveCart(cart);
    renderCartTable();
  }
  function removeItem(id) {
    const cart = readCart().filter(i => String(i.id) !== String(id));
    saveCart(cart);
    renderCartTable();
  }
  function cartTotal() {
    return readCart().reduce((acc, it) => acc + it.preco * it.qtd, 0);
  }
  function formatBRL(n) {
    return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  // ---------- CAT√ÅLOGO ----------
  async function carregarProdutos() {
    const candidatos = [
      `${API_BASE}/produtos`, // caso a API tenha endpoint /produtos
      `${API_BASE}`           // fallback para JSON na raiz
    ];

    let produtos = null;
    let ultimoErro = null;

    for (const url of candidatos) {
      try {
        const res = await fetch(url, { mode: "cors", cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (Array.isArray(data)) { // raiz √© array
          produtos = data;
          break;
        }
        if (data && Array.isArray(data.produtos)) { // dentro de { produtos: [...] }
          produtos = data.produtos;
          break;
        }
      } catch (e) {
        ultimoErro = e;
      }
    }

    if (!produtos) {
      console.error("[cat√°logo] falha ao buscar produtos:", ultimoErro);
      document.getElementById("produtos").innerHTML =
        `<p style="color:#dc2626">Erro ao carregar produtos.</p>`;
      return;
    }

    window.__produtos = produtos;
    const el = document.getElementById("produtos");

    el.innerHTML = produtos.map(p => {
      const imgSrc = p.imagem && p.imagem.startsWith("http")
        ? p.imagem
        : `${repo}/${String(p.imagem || "").replace(/^\/?/, "")}`;

      return `
        <div class="card" data-id="${p.id}">
          <div class="thumb">
            <img
              src="${imgSrc}"
              alt="${p.nome}"
              referrerpolicy="no-referrer"
              onerror="this.onerror=null; this.src='https://picsum.photos/seed/erro/600/450';"
            />
          </div>
          <h3>${p.nome}</h3>
          <p>${p.descricao ?? ""}</p>
          <div class="meta">
            <span class="price">${formatBRL(Number(p.preco))}</span>
            <button class="btn btn-add" type="button" data-id="${p.id}">Adicionar</button>
          </div>
        </div>
      `;
    }).join("");
  }

  // ---------- NAVEGA√á√ÉO ----------
  function hideAll() {
    document.getElementById("produtos").style.display = "none";
    const dash = document.getElementById("sec-dashboard");
    if (dash) dash.style.display = "none";
    const carr = document.getElementById("sec-carrinho");
    if (carr) carr.style.display = "none";
  }
  function setTitulo(t) { const h = document.querySelector("main h1"); if (h) h.textContent = t; }

  function mostrarCatalogo() {
    hideAll();
    document.getElementById("produtos").style.display = "";
    setTitulo("Cat√°logo de Produtos");
  }
  function mostrarDashboard() {
    hideAll();
    const dash = document.getElementById("sec-dashboard");
    if (dash) dash.style.display = "";
    setTitulo("Dashboard de Vendas");
    desenharGraficoVendas();
  }
  function mostrarCarrinho() {
    hideAll();
    const carr = document.getElementById("sec-carrinho");
    if (carr) carr.style.display = "";
    setTitulo("Seu Carrinho");
    renderCartTable();
  }

  // ---------- CARRINHO ----------
  function renderCartTable() {
    const tbody = document.getElementById("cart-body");
    const empty = document.getElementById("cart-empty");
    const totalEl = document.getElementById("cart-total");
    if (!tbody || !empty || !totalEl) return;

    const cart = readCart();
    if (cart.length === 0) {
      empty.style.display = "";
      tbody.innerHTML = "";
      totalEl.textContent = formatBRL(0);
      updateCartCount();
      return;
    }
    empty.style.display = "none";

    tbody.innerHTML = cart.map(item => `
      <tr>
        <td style="padding:10px 6px;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:10px">
          <img src="${item.imagem?.startsWith('http') ? item.imagem : (item.imagem ? (repo + '/' + item.imagem.replace(/^\/?/, '')) : 'https://picsum.photos/seed/p/60/60')}"
               alt="${item.nome}" style="width:56px;height:42px;object-fit:cover;border-radius:8px;background:#f1f5f9">
          <strong>${item.nome}</strong>
        </td>
        <td style="padding:10px 6px;border-bottom:1px solid #e2e8f0">${formatBRL(item.preco)}</td>
        <td style="padding:10px 6px;border-bottom:1px solid #e2e8f0">
          <div style="display:inline-flex;align-items:center;gap:6px">
            <button class="btn btn-qtd" data-act="dec" data-id="${item.id}" type="button">‚àí</button>
            <input type="number" min="1" value="${item.qtd}" data-id="${item.id}" class="inp-qtd">
            <button class="btn btn-qtd" data-act="inc" data-id="${item.id}" type="button">+</button>
          </div>
        </td>
        <td style="padding:10px 6px;border-bottom:1px solid #e2e8f0;font-weight:700">
          ${formatBRL(item.preco * item.qtd)}
        </td>
        <td style="padding:10px 6px;border-bottom:1px solid #e2e8f0">
          <button class="btn" data-act="rm" data-id="${item.id}" type="button" style="background:#dc2626">Remover</button>
        </td>
      </tr>
    `).join("");

    totalEl.textContent = formatBRL(cartTotal());
    updateCartCount();
  }

  // ---------- GR√ÅFICO ----------
  function desenharGraficoVendas() {
    const ctx = document.getElementById("chartVendas");
    if (!ctx) return;
    if (window.__graficoVendas) window.__graficoVendas.destroy();
    window.__graficoVendas = new Chart(ctx, {
      type: "bar",
      data: { labels: ["Jan","Fev","Mar","Abr","Mai","Jun"], datasets: [{ label: "Vendas (R$)", data: [1200,1750,1600,2100,1950,2500] }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  // ---------- BOOT ----------
  document.addEventListener("DOMContentLoaded", () => {
    const usuario = localStorage.getItem("usuario");
    const role = localStorage.getItem("role") || "cliente";
    if (!usuario) {
      alert("Voc√™ precisa fazer login primeiro.");
      location.href = `${repo}/login.html`;
      return;
    }

    // UI
    document.getElementById("welcome-name").textContent = usuario;
    document.getElementById("role-label").textContent = role === "admin" ? "Administrador" : "Cliente";

    document.getElementById("btnSair").onclick = () => { localStorage.clear(); location.href = `${repo}/login.html`; };

    document.getElementById("btnInicio")?.addEventListener("click", mostrarCatalogo);
    document.getElementById("btnCatalogo")?.addEventListener("click", mostrarCatalogo);
    const btnDash = document.getElementById("btnDashboard");
    if (btnDash) {
      if (role === "admin") { btnDash.style.display = ""; btnDash.onclick = mostrarDashboard; }
      else btnDash.style.display = "none";
    }
    document.getElementById("btnCarrinho")?.addEventListener("click", mostrarCarrinho);
    document.getElementById("btnContinuar")?.addEventListener("click", mostrarCatalogo);
    document.getElementById("btnCheckout")?.addEventListener("click", () => {
      alert(`Checkout de demonstra√ß√£o ü§ç\nTotal: ${formatBRL(cartTotal())}`);
    });

    // Eventos de cat√°logo
    document.getElementById("produtos")?.addEventListener("click", ev => {
      const btn = ev.target.closest(".btn-add");
      if (!btn) return;
      const id = btn.dataset.id;
      const prod = (window.__produtos || []).find(p => String(p.id) === String(id));
      if (!prod) return alert("Produto n√£o encontrado.");
      addToCart(prod, 1);
      btn.textContent = "Adicionado! ‚úì";
      setTimeout(() => (btn.textContent = "Adicionar"), 900);
    });

    // Eventos de carrinho
    document.getElementById("sec-carrinho")?.addEventListener("click", ev => {
      const b = ev.target.closest("button");
      if (!b) return;
      const id = b.dataset.id;
      if (b.dataset.act === "inc") incQty(id, +1);
      if (b.dataset.act === "dec") incQty(id, -1);
      if (b.dataset.act === "rm") removeItem(id);
    });
    document.getElementById("sec-carrinho")?.addEventListener("change", ev => {
      const inp = ev.target.closest(".inp-qtd");
      if (!inp) return;
      const id = inp.dataset.id;
      setQty(id, Math.max(1, Number(inp.value || 1)));
    });

    updateCartCount();
    mostrarCatalogo();
    carregarProdutos();
  });
</script>

</body>
</html>
